

# Skywalkingé“¾è·¯ç›‘æ§

## 1ã€Skywalkingæ¦‚è¿°

**è¯·æ±‚é“¾è·¯è¿½è¸ªï¼Œæ•…éšœå¿«é€Ÿå®šä½**ï¼šå¯ä»¥é€šè¿‡è°ƒç”¨é“¾ç»“åˆä¸šåŠ¡æ—¥å¿—å¿«é€Ÿå®šä½é”™è¯¯ä¿¡æ¯ã€‚

**å¯è§†åŒ–**ï¼šå„ä¸ªé˜¶æ®µè€—æ—¶ï¼Œè¿›è¡Œæ€§èƒ½åˆ†æã€‚

**ä¾èµ–ä¼˜åŒ–**ï¼šå„ä¸ªè°ƒç”¨ç¯èŠ‚çš„å¯ç”¨æ€§ã€æ¢³ç†æœåŠ¡ä¾èµ–å…³ç³»ä»¥åŠä¼˜åŒ–ã€‚

**æ•°æ®åˆ†æï¼Œä¼˜åŒ–é“¾è·¯**ï¼šå¯ä»¥å¾—åˆ°ç”¨æˆ·çš„è¡Œä¸ºè·¯å¾„ï¼Œæ±‡æ€»åˆ†æåº”ç”¨åœ¨å¾ˆå¤šä¸šåŠ¡åœºæ™¯




### 1.1 APMç³»ç»Ÿæ¦‚è¿°

APM (Application Performance Management) å³åº”ç”¨æ€§èƒ½ç®¡ç†ç³»ç»Ÿï¼Œæ˜¯å¯¹ä¼ä¸šç³»ç»Ÿå³æ—¶ç›‘æ§ä»¥å®ç°
å¯¹åº”ç”¨ç¨‹åºæ€§èƒ½ç®¡ç†å’Œæ•…éšœç®¡ç†çš„ç³»ç»ŸåŒ–çš„è§£å†³æ–¹æ¡ˆã€‚åº”ç”¨æ€§èƒ½ç®¡ç†ï¼Œä¸»è¦æŒ‡å¯¹ä¼ä¸šçš„å…³é”®ä¸šåŠ¡åº”ç”¨è¿›
è¡Œç›‘æµ‹ã€ä¼˜åŒ–ï¼Œæé«˜ä¼ä¸šåº”ç”¨çš„å¯é æ€§å’Œè´¨é‡ï¼Œä¿è¯ç”¨æˆ·å¾—åˆ°è‰¯å¥½çš„æœåŠ¡ï¼Œé™ä½ITæ€»æ‹¥æœ‰æˆæœ¬ã€‚

**APMç³»ç»Ÿæ˜¯å¯ä»¥å¸®åŠ©ç†è§£ç³»ç»Ÿè¡Œä¸ºã€ç”¨äºåˆ†ææ€§èƒ½é—®é¢˜çš„å·¥å…·ï¼Œä»¥ä¾¿å‘ç”Ÿæ•…éšœçš„æ—¶å€™ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚**

### 1.2 åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

éšç€åˆ†å¸ƒå¼ç³»ç»Ÿå’Œå¾®æœåŠ¡æ¶æ„çš„å‡ºç°ï¼Œä¸€æ¬¡ç”¨æˆ·çš„è¯·æ±‚ä¼šç»è¿‡å¤šä¸ªç³»ç»Ÿï¼Œä¸åŒæœåŠ¡ä¹‹é—´çš„è°ƒç”¨å…³ç³»ååˆ†
å¤æ‚ï¼Œä»»ä½•ä¸€ä¸ªç³»ç»Ÿå‡ºé”™éƒ½å¯èƒ½å½±å“æ•´ä¸ªè¯·æ±‚çš„å¤„ç†ç»“æœã€‚ä»¥å¾€çš„ç›‘æ§ç³»ç»Ÿå¾€å¾€åªèƒ½çŸ¥é“å•ä¸ªç³»ç»Ÿçš„å¥
åº·çŠ¶å†µã€ä¸€æ¬¡è¯·æ±‚çš„æˆåŠŸå¤±è´¥ï¼Œæ— æ³•å¿«é€Ÿå®šä½å¤±è´¥çš„æ ¹æœ¬åŸå› ã€‚

### 1.3 ä¸»æµçš„å¼€æºAPMäº§å“

**SkyWalking**
SkyWalkingæ˜¯apacheåŸºé‡‘ä¼šä¸‹é¢çš„ä¸€ä¸ªå¼€æºAPMé¡¹ç›®ï¼Œä¸ºå¾®æœåŠ¡æ¶æ„å’Œäº‘åŸç”Ÿæ¶æ„ç³»ç»Ÿè®¾è®¡ã€‚å®ƒé€šè¿‡æ¢é’ˆè‡ªåŠ¨æ”¶é›†æ‰€éœ€çš„æŒ‡æ ‡ï¼Œå¹¶è¿›è¡Œåˆ†å¸ƒå¼è¿½è¸ªã€‚é€šè¿‡è¿™äº›è°ƒç”¨é“¾è·¯ä»¥åŠæŒ‡æ ‡ï¼ŒSkywalking APMä¼šæ„ŸçŸ¥åº”ç”¨é—´å…³ç³»å’ŒæœåŠ¡é—´å…³ç³»ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„æŒ‡æ ‡ç»Ÿè®¡ã€‚Skywalkingæ”¯æŒé“¾è·¯è¿½è¸ªå’Œç›‘æ§åº”ç”¨ç»„ä»¶åŸºæœ¬æ¶µç›–

**Zipkin**
Zipkinæ˜¯ç”±Twitterå¼€æºï¼Œæ˜¯åˆ†å¸ƒå¼é“¾è·¯è°ƒç”¨ç›‘æ§ç³»ç»Ÿï¼Œèšåˆå„ä¸šåŠ¡ç³»ç»Ÿè°ƒç”¨å»¶è¿Ÿæ•°æ®ï¼Œè¾¾åˆ°é“¾è·¯è°ƒç”¨ç›‘æ§è·Ÿè¸ªã€‚ZipkinåŸºäºGoogleçš„Dapperè®ºæ–‡å®ç°ï¼Œä¸»è¦å®Œæˆæ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€æœç´¢ä¸ç•Œé¢å±•ç¤ºã€‚

**PinPoint**
Pinpointæ˜¯ç”±ä¸€ä¸ªéŸ©å›½å›¢é˜Ÿå®ç°å¹¶å¼€æºï¼Œé’ˆå¯¹Javaç¼–å†™çš„å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ï¼Œé€šè¿‡JavaAgentçš„æœºåˆ¶åšå­—èŠ‚ä»£ç æ¤å…¥ï¼Œå®ç°åŠ å…¥traceidå’Œè·å–æ€§èƒ½æ•°æ®çš„ç›®çš„ï¼Œå¯¹åº”ç”¨ä»£ç é›¶ä¾µå…¥ã€‚

**CAT**
CATæ˜¯ç”±å¤§ä¼—ç‚¹è¯„å¼€æºçš„é¡¹ç›®ï¼ŒåŸºäºJavaå¼€å‘çš„å®æ—¶åº”ç”¨ç›‘æ§å¹³å°ï¼ŒåŒ…æ‹¬å®æ—¶åº”ç”¨ç›‘æ§ï¼Œä¸šåŠ¡ç›‘æ§ï¼Œå¯ä»¥æä¾›åå‡ å¼ æŠ¥è¡¨å±•ç¤ºã€‚


## 2ã€SkywalkingåŸç†

### 2.1 java agentåŸç†

ä½¿ç”¨Skywalkingå»ç›‘æ§æœåŠ¡ï¼Œéœ€è¦åœ¨å…¶ VM å‚æ•°ä¸­æ·»åŠ  â€œ-
javaagent:/usr/local/skywalking/agent//skywalking-agent.jar"ã€‚è¿™é‡Œå°± ä½¿ç”¨åˆ°äº†java agentæŠ€æœ¯ã€‚

**2.1.1ã€Java agent æ˜¯ä»€ä¹ˆï¼Ÿ**

Java agentæ˜¯javaå‘½ä»¤çš„ä¸€ä¸ªå‚æ•°ã€‚å‚æ•° javaagent å¯ä»¥ç”¨äºæŒ‡å®šä¸€ä¸ª jar åŒ…ã€‚

1. è¿™ä¸ª jar åŒ…çš„ MANIFEST.MF æ–‡ä»¶å¿…é¡»æŒ‡å®š Premain-Class é¡¹ã€‚
2. Premain-Class æŒ‡å®šçš„é‚£ä¸ªç±»å¿…é¡»å®ç° premain() æ–¹æ³•ã€‚

å½“Java è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œåœ¨æ‰§è¡Œ main å‡½æ•°ä¹‹å‰ï¼ŒJVM ä¼šå…ˆè¿è¡Œ -javaagentæ‰€æŒ‡å®š jar åŒ…å†… Premain- Class è¿™ä¸ªç±»çš„ premain æ–¹æ³• ã€‚

**2.1.2ã€å¦‚ä½•ä½¿ç”¨java agentï¼Ÿ**
ä½¿ç”¨ java agent éœ€è¦å‡ ä¸ªæ­¥éª¤ï¼š

1. å®šä¹‰ä¸€ä¸ª MANIFEST.MF æ–‡ä»¶ï¼Œå¿…é¡»åŒ…å« Premain-Class é€‰é¡¹ï¼Œé€šå¸¸ä¹Ÿä¼šåŠ å…¥Can-Redeï¬ne- Classes å’Œ Can-Retransform-Classes é€‰é¡¹ã€‚
2. åˆ›å»ºä¸€ä¸ªPremain-Class æŒ‡å®šçš„ç±»ï¼Œç±»ä¸­åŒ…å« premain æ–¹æ³•ï¼Œæ–¹æ³•é€»è¾‘ç”±ç”¨æˆ·è‡ªå·±ç¡®å®šã€‚
3. å°† premain çš„ç±»å’Œ MANIFEST.MF æ–‡ä»¶æ‰“æˆ jar åŒ…ã€‚
4. ä½¿ç”¨å‚æ•° -javaagent: jaråŒ…è·¯å¾„ å¯åŠ¨è¦ä»£ç†çš„æ–¹æ³•ã€‚

** ç¤ºä¾‹ä»£ç **

```
import net.bytebuddy.agent.builder.AgentBuilder;
import net.bytebuddy.description.method.MethodDescription;
import net.bytebuddy.description.type.TypeDescription;
import net.bytebuddy.dynamic.DynamicType;
import net.bytebuddy.implementation.MethodDelegation;
import net.bytebuddy.matcher.ElementMatchers;
import net.bytebuddy.utility.JavaModule;

import java.lang.instrument.Instrumentation;

public class PreMainAgent {

    public static void premain(String agentArgs, Instrumentation inst) {
        System.out.println("=========premainæ–¹æ³•æ‰§è¡Œ1========");
        System.out.println(agentArgs);
    }
}

```

> ç±»ä¸­æä¾›ä¸¤ä¸ªé™æ€æ–¹æ³•ï¼Œæ–¹æ³•åå‡ä¸ºpremainï¼Œä¸èƒ½æ‹¼é”™

åœ¨pomæ–‡ä»¶ä¸­æ·»åŠ æ‰“åŒ…æ’ä»¶

```
<build>
        <plugins>
            <plugin>
                <artifactId>maven-assembly-plugin</artifactId>
                <configuration>
                    <appendAssemblyId>false</appendAssemblyId>
                    <descriptorRefs>
                        <descriptorRef>jar-with-dependencies</descriptorRef>
                    </descriptorRefs>
                    <archive>
                        <!--è‡ªåŠ¨æ·»åŠ META-INF/MANIFEST.MF -->
                        <manifest>
                            <addClasspath>true</addClasspath>
                        </manifest>
                        <manifestEntries>
                            <Premain-Class>PreMainAgent</Premain-Class>
                            <Agent-Class>PreMainAgent</Agent-Class>
                            <Can-Redefine-Classes>true</Can-Redefine-Classes>
                            <Can-Retransform-Classes>true</Can-Retransform-Classes>
                        </manifestEntries>
                    </archive>
                </configuration>
                <executions>
                    <execution>
                        <id>make-assembly</id>
                        <phase>package</phase>
                        <goals>
                            <goal>single</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
```

è¯¥æ’ä»¶ä¼šåœ¨è‡ªåŠ¨ç”ŸæˆMETA-INF/MANIFEST.MFæ–‡ä»¶æ—¶ï¼Œå¸®æˆ‘ä»¬æ·»åŠ agentç›¸å…³çš„é…ç½®ä¿¡æ¯ã€‚ ä½¿ç”¨mavençš„packageå‘½ä»¤è¿›è¡Œæ‰“åŒ…ï¼š

**2.1.3ã€ ç»Ÿè®¡æ–¹æ³•è°ƒç”¨æ—¶é—´**

Skywalkingä¸­å¯¹æ¯ä¸ªè°ƒç”¨çš„æ—¶é•¿éƒ½è¿›è¡Œäº†ç»Ÿè®¡ï¼Œä½¿ç”¨ByteBuddyå’ŒJava agentæŠ€æœ¯æ¥ ç»Ÿè®¡æ–¹æ³•çš„è°ƒç”¨æ—¶é•¿ã€‚

Byte Buddyæ˜¯å¼€æºçš„ã€åŸºäºApache 2.0è®¸å¯è¯çš„åº“ï¼Œå®ƒè‡´åŠ›äºè§£å†³å­—èŠ‚ç æ“ä½œå’Œinstrumentation API çš„å¤æ‚æ€§ã€‚Byte Buddyæ‰€å£°ç§°çš„ç›®æ ‡æ˜¯å°†æ˜¾å¼çš„å­—èŠ‚ç æ“ä½œéšè—åœ¨ä¸€ä¸ªç±»å‹å®‰å…¨çš„é¢†åŸŸç‰¹å®šè¯­è¨€èƒŒ åã€‚é€šè¿‡ä½¿ç”¨Byte Buddyï¼Œä»»ä½•ç†Ÿæ‚‰Javaç¼–ç¨‹è¯­è¨€çš„äººéƒ½æœ‰æœ›éå¸¸å®¹æ˜“åœ°è¿›è¡Œå­—èŠ‚ç æ“ä½œã€‚Byte Buddyæä¾›äº†é¢å¤–çš„APIæ¥ç”ŸæˆJava agentï¼Œå¯ä»¥è½»æ¾çš„å¢å¼ºæˆ‘ä»¬å·²æœ‰çš„ä»£ç ã€‚

æ·»åŠ ä¾èµ–ï¼š

```
<dependencies>
        <dependency>
            <groupId>net.bytebuddy</groupId>
            <artifactId>byte-buddy</artifactId>
        </dependency>
        <dependency>
            <groupId>net.bytebuddy</groupId>
            <artifactId>byte-buddy-agent</artifactId>
        </dependency>
</dependencies>
```

ä¿®æ”¹PreMainAgentä»£ç 

```
public class PreMainAgent {

    public static void premain(String agentArgs, Instrumentation inst) {
    
        //åˆ›å»ºä¸€ä¸ªè½¬æ¢å™¨ï¼Œè½¬æ¢å™¨å¯ä»¥ä¿®æ”¹ç±»çš„å®ç°
        //ByteBuddyå¯¹java agentæä¾›äº†è½¬æ¢å™¨çš„å®ç°ï¼Œç›´æ¥ä½¿ç”¨å³å¯
        AgentBuilder.Transformer transformer = new AgentBuilder.Transformer() {
            public DynamicType.Builder<?> transform(DynamicType.Builder<?> builder, TypeDescription typeDescription, ClassLoader classLoader, JavaModule javaModule) {
                return builder
                        // æ‹¦æˆªä»»æ„æ–¹æ³•
                        .method(ElementMatchers.<MethodDescription>any())
                        // æ‹¦æˆªåˆ°çš„æ–¹æ³•å§”æ‰˜ç»™TimeInterceptor
                        .intercept(MethodDelegation.to(MyInterceptor.class));
            }
        };
        
        new AgentBuilder // Byte Buddyä¸“é—¨æœ‰ä¸ªAgentBuilderæ¥å¤„ç†Java Agentçš„åœºæ™¯
                .Default()
                // æ ¹æ®åŒ…åå‰ç¼€æ‹¦æˆªç±»
                .type(ElementMatchers.nameStartsWith("com.agent"))
                // æ‹¦æˆªåˆ°çš„ç±»ç”±transformerå¤„ç†
                .transform(transformer)
                .installOn(inst);
    }
}

```

å…ˆç”Ÿæˆä¸€ä¸ªè½¬æ¢å™¨ï¼ŒByteBuddyæä¾›äº†java agentä¸“ç”¨çš„è½¬æ¢å™¨ã€‚é€šè¿‡å®ç°Transformeræ¥å£åˆ©ç”¨ builderå¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªè½¬æ¢å™¨ã€‚è½¬æ¢å™¨å¯ä»¥é…ç½®æ‹¦æˆªæ–¹æ³•çš„æ ¼å¼ï¼Œæ¯”å¦‚ç”¨åç§°ï¼Œæœ¬ä¾‹ä¸­æ‹¦æˆªæ‰€æœ‰æ–¹ æ³•ï¼Œå¹¶å®šä¹‰ä¸€ä¸ªæ‹¦æˆªå™¨ç±»MyInterceptorã€‚

```
public class MyInterceptor {
    @RuntimeType
    public static Object intercept(@Origin Method method,
                                   @SuperCall Callable<?> callable)
            throws Exception {
        long start = System.currentTimeMillis();
        try {
            //æ‰§è¡ŒåŸæ–¹æ³•
            return callable.call();
        } finally {
            //æ‰“å°è°ƒç”¨æ—¶é•¿
            System.out.println(method.getName() + ":" + (System.currentTimeMillis() - start)  + "ms");
        }
    }
}

```

MyInterceptorå°±æ˜¯ä¸€ä¸ªæ‹¦æˆªå™¨çš„å®ç°ï¼Œç»Ÿè®¡çš„è°ƒç”¨çš„æ—¶é•¿ã€‚å‚æ•°ä¸­çš„methodæ˜¯åå°„å‡ºçš„æ–¹æ³•å¯¹è±¡ï¼Œè€Œ callableå°±æ˜¯è°ƒç”¨å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡callable.callï¼ˆï¼‰æ–¹æ³•æ¥æ‰§è¡ŒåŸæ–¹æ³•ã€‚



## 3ã€Skywalking ç¯å¢ƒæ­å»º

**3.1 è½¯ä»¶å‡†å¤‡**

è½¯ä»¶åŒ…ç‰ˆæœ¬å·²ç»ä¸Šä¼ 140Gitlab

apache-skywalking-apm-8.1.0.tar.gz

```
http://39.100.254.140:12011/loit-Infrastructure-doc/loit-initproject-doc/tree/master/3%E3%80%81other/%E9%9B%86%E6%88%90loit%E9%97%A8%E6%88%B7/skywalking/8.1.0/apache-skywalking-apm-8.1.0.tar.gz
```

å°†ä»¥ä¸Šä¸‰ä¸ªè½¯ä»¶åŒ…ä¸Šä¼ è‡³æœåŠ¡å™¨/usr/local/src/è·¯å¾„ä¸‹

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200812105749288.png#pic_center)



**3.2 å®‰è£…SkywalkingæœåŠ¡ç«¯**

**è§£å‹å®‰è£…åŒ…**
```
cd /usr/local/src

tar -zxvf apache-skywalking-apm-8.1.0.tar.gz
mv apache-skywalking-apm-bin skywalking
mv skywalking/ /usr/local/
```

ä¿®æ”¹é…ç½®æ–‡ä»¶

```
vim /usr/local/skywalking/config/application.yml
```

1ã€å…¶ä¸­ä¿®æ”¹ï¼šselectorä¸clusterNodes

```
storage:
  selector: ${SW_STORAGE:elasticsearch}
  elasticsearch:
    nameSpace: ${SW_NAMESPACE:""}
    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:172.16.203.79:9200,172.16.203.78:9200,172.16.203.79:9200}

```
2ã€å…¶ä¸­ gRPCHostæ”¹æˆæœ¬æœºæœåŠ¡å™¨IP

```
core:
  selector: ${SW_CORE:default}
  default:
    gRPCHost: ${SW_CORE_GRPC_HOST:172.16.203.77}
```
2ã€å…¶ä¸­å­˜å‚¨ä¸ºes
```
storage:
  selector: ${SW_STORAGE:elasticsearch}
  elasticsearch:
    nameSpace: ${SW_NAMESPACE:""}
    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:172.16.203.77:9200,172.16.203.78:9200,172.16.203.79:9200}
```

**collector é›†ç¾¤**

åˆ†åˆ«åœ¨ä¸€ä¸‹3å°æœåŠ¡å™¨å¯åŠ¨collector ï¼š

```
172.16.203.76
172.16.203.77 172.16.203.78
cd /usr/local/skywalking/bin/sh oapService.sh
```

**dashboardé…ç½®åŠå¯åŠ¨**

åœ¨å…¶ä¸­ä¸€å°172.16.203.76é…ç½®åŠå…¶å¯åŠ¨
```
vim /usr/local/skywalking/webapp/webapp.yml
```

ä¿®æ”¹ç«¯å£å·server.port ä¸ listOfServersï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰

```
server:
  port: 8051

collector:
  path: /graphql
  ribbon:
    ReadTimeout: 10000
    # Point to all backend's restHost:restPort, split by ,
    listOfServers: 172.16.203.76:12800,172.16.203.77:12800,172.16.203.78:12800
```

å¯åŠ¨dashboardï¼š

```
cd /usr/local/skywalking/bin/
sh webappService.sh 
```

**æœåŠ¡ç«¯äº§ç”Ÿçš„æ—¥å¿—è·¯å¾„**

```
/usr/local/skywalking/logs
```

**åœæ­¢skywalking**

```
# å…³é—­ skywalking web

    ps -ef|grep skywalking-webapp
    kill -9 pid

```

æ³¨æ„*skywalking*é»˜è®¤ä¼šä½¿ç”¨(8080, 10800, **11800**, 12800)ç«¯å£ï¼Œ å‰é¢å·²ç»æŠŠ8080 ä¿®æ”¹ä¸º8051


**3.3 å®‰è£…Skywalking agent ç«¯**

å®é™…å¼€å‘æ—¶å€™ï¼Œæ¯ä¸€ä¸ªjaråŒ…è·å–åº”ç”¨éƒ½åº”è¯¥å•ç‹¬ä½¿ç”¨ä¸€ä¸ªagentï¼Œ
æ‰€ä»¥å°†agentè¿™ä¸ªç›®å½•æ‹·è´åˆ°å„è‡ªå¯¹åº”çš„jaråŒ…è·¯å¾„ä¸‹ã€‚
æ ¸å¿ƒéƒ¨åˆ†çš„ç›®å½•ä¿¡æ¯å¦‚ä¸‹:

```
â”œâ”€â”€ activations
â”œâ”€â”€ config
â”‚   â””â”€â”€ agent.config
â”œâ”€â”€ logs
â”‚   â””â”€â”€ skywalking-api.log
â”œâ”€â”€ optional-plugins
â”œâ”€â”€ plugins
â””â”€â”€ skywalking-agent.jar

```



ä¸Šä¼ skywalking å¹¶è§£å‹

```
cd /usr/local/src

tar -zxvf apache-skywalking-apm-8.1.0.tar.gz
mv apache-skywalking-apm-bin skywalking
mv skywalking/ /usr/local/
```

æ·»åŠ gateway plugin æ’ä»¶

```
cd /usr/local/skywalking/agent/optional-plugins
cp apm-spring-cloud-gateway-2.0.x-plugin-8.1.0.jar /usr/local/skywalking/agent/plugins/
```



è®¾ç½®å¥½å‚æ•°åï¼Œå¯¹äº Java åº”ç”¨ï¼Œæ·»åŠ æ ¸å¿ƒçš„-javaagentè¿›è¡Œå¯åŠ¨

```
-javaagent:/usr/local/skywalking/agent/skywalking-agent.jar -Dskywalking.agent.service_name=loit-gateway -Dskywalking.collector.backend_service=172.16.203.76:11800,172.16.203.77:11800,172.16.203.78:11800
```



ç¤ºä¾‹å¯åŠ¨è„šæœ¬å¦‚ä¸‹ï¼š

```
nohup /usr/local/java/jdk1.8/bin/java -javaagent:/usr/local/skywalking/agent/skywalking-agent.jar -Dskywalking.agent.service_name=loit-gateway -Dskywalking.collector.backend_service=172.16.203.76:11800,172.16.203.77:11800,172.16.203.78:11800  -Xms512m -Xmx512m -XX:PermSize=128M -XX:MaxPermSize=256M -jar -Dlogging.config=/home/soft/loit-gateway-7001/logback-dev.xml  -Dlogging.path=/home/soft/loit-gateway-7001/logs $KILL_PROCESS_NAME  --spring.config.location=file:./application-test7001.yml &

```



## 4ã€Skywalking æ€§èƒ½æµ‹è¯•



> æµ‹è¯•åŒ…å«ä¸€äº›å‡ ç‚¹å†…å®¹

1ã€æµ‹è¯•ä½¿ç”¨skywalkingå‰åçš„cpuã€å†…å­˜ã€ç£ç›˜ã€QPSå˜åŒ–æƒ…å†µ
2ã€SkywalkingæŒ‚æ‰åå¯¹å¾®æœåŠ¡çš„å½±å“
3ã€é“¾è·¯ç›‘æ§æ—¥å¿—å¢é•¿æƒ…å†µ
4ã€Skywalkingé‡å¯åæ˜¯å¦å¯ä»¥ç»§ç»­æ”¶é›†é“¾è·¯æ—¥å¿—ï¼ˆå®¢æˆ·ç«¯ä¸é‡å¯ï¼‰
5ã€é«˜å¹¶å‘ã€é•¿æ—¶é—´å‹æµ‹å¾®æœåŠ¡ï¼Œskywalkingæ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨



### 4.1 æµ‹è¯•ç¯å¢ƒå‡†å¤‡

æœåŠ¡ç«¯IPå¦‚ä¸‹

```
http://121.196.16.86:8051
```



å®¢æˆ·ç«¯æœåŠ¡å™¨IPå¦‚ä¸‹ï¼š

```
172.16.203.77
172.16.203.78
172.16.203.79
```

>  ä¸‰å°æœåŠ¡å™¨éƒ½æŒ‰ç…§ã€Š3.3 å®‰è£…Skywalking agent ç«¯ã€‹å®‰è£…å®¢æˆ·ç«¯ã€‚



ä¸‰å°æœåŠ¡å™¨éƒ½å¯åŠ¨gateway (å…¶ä¸­ **deploy-gateway-sky-7001.sh** ä¸ºå¸¦skywalkingè„šæœ¬ï¼Œdeploy-gateway-7001.sh ä¸ºæ— skywalkingå¯åŠ¨è„šæœ¬)

```
cd /home/soft/loit-gateway-7001/
sh deploy-gateway-sky-7001.sh
```



ä¸‰å°å¯åŠ¨portal(å…¶ä¸­ **deploy-portal-sky-7005.sh** ä¸ºå¸¦skywalkingè„šæœ¬ï¼Œdeploy-portal-7005.s ä¸ºæ— skywalkingå¯åŠ¨è„šæœ¬)

```
cd /home/soft/portal-7005/
sh deploy-portal-sky-7005.sh
```



### 4.2 è¿‡ç¨‹æµ‹è¯•



**4.2.1 æ€§èƒ½å½±å“æµ‹è¯•**

* åœ¨172.16.203.77 æœåŠ¡å™¨ä¸Šè¿è¡Œwrkè¿›è¡Œæµ‹è¯•
* åˆ†åˆ«æµ‹è¯•ä½¿ç”¨skywalkingå‰åå˜åŒ–æƒ…å†µï¼Œå‘è¿æ¥æ•°åˆ†åˆ«æµ‹è¯•**500ã€1000ã€5000**
* æµ‹è¯•æŒ‡æ ‡æ¯”å¯¹ä½¿ç”¨skywalkingå‰åçš„ **QPSã€å†…å­˜ã€cpuã€ç£ç›˜ç©ºé—´**å˜åŒ–æƒ…å†µ

```
wrk -t30 -c500 -d30s http://172.16.203.78/test/json
```



ğŸšš **500 å¹¶å‘(æ— é“¾è·¯ç›‘æ§)**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811214652104.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3Mzg0NzY5,size_16,color_FFFFFF,t_70)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811212743656.png)

- 8æ ¸CPUä½¿ç”¨668.9%ï¼Œå†…å­˜ä½¿ç”¨2.5% ï¼ŒQPS ä¸º **28482.96** 
- å¹³å‡å»¶è¿Ÿä¸º 17.27ms



ğŸšš **1000 å¹¶å‘(æ— é“¾è·¯ç›‘æ§)**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811214553945.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3Mzg0NzY5,size_16,color_FFFFFF,t_70)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811212620981.png)

- 8æ ¸CPUä½¿ç”¨662.1%ï¼Œå†…å­˜ä½¿ç”¨2.5% ï¼ŒQPS ä¸º **26296.37** 

- å¹³å‡å»¶è¿Ÿä¸º 38.14ms

  â€‹

ğŸšš **5000 å¹¶å‘(æ— é“¾è·¯ç›‘æ§)**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811214508182.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3Mzg0NzY5,size_16,color_FFFFFF,t_70)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811212524762.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3Mzg0NzY5,size_16,color_FFFFFF,t_70)



- 8æ ¸CPUä½¿ç”¨646.1%ï¼Œå†…å­˜ä½¿ç”¨2.5% ï¼ŒQPS ä¸º **17829.78** 
- å¹³å‡å»¶è¿Ÿä¸º 213.71ms



ğŸšš **500 å¹¶å‘(skywalking)**



![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811211434358.png)

- QPS ä¸º **23867.47** 
- å¹³å‡å»¶è¿Ÿä¸º 20.48ms



ğŸšš **1000 å¹¶å‘(skywalking)**
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811211654142.png)

- QPS ä¸º **22053.67** 
- å¹³å‡å»¶è¿Ÿä¸º 45.82ms



ğŸšš **5000 å¹¶å‘(skywalking)**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811212117759.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3Mzg0NzY5,size_16,color_FFFFFF,t_70)
---

- QPS ä¸º **15207.78** 
- å¹³å‡å»¶è¿Ÿä¸º 248.63ms



ğŸšš **500 å¹¶å‘(åœæ­¢skywalking server)**


![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811213347347.png)
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811213413640.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3Mzg0NzY5,size_16,color_FFFFFF,t_70)

- 8æ ¸cpuä½¿ç”¨658.8%ï¼Œå†…å­˜ä½¿ç”¨2.0%ï¼ŒQPS ä¸º **26894.59** 
- å¹³å‡å»¶è¿Ÿä¸º 18.29ms



ğŸšš **1000 å¹¶å‘(åœæ­¢skywalking server)**
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811213531204.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811213457827.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3Mzg0NzY5,size_16,color_FFFFFF,t_70)

- 8æ ¸cpuä½¿ç”¨655.5%ï¼Œå†…å­˜ä½¿ç”¨2.7%ï¼ŒQPS ä¸º **24091.45** 
- å¹³å‡å»¶è¿Ÿä¸º 41.85ms



ğŸšš **5000 å¹¶å‘(åœæ­¢skywalking server)**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811213604363.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3Mzg0NzY5,size_16,color_FFFFFF,t_70)
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200811213628781.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3Mzg0NzY5,size_16,color_FFFFFF,t_70)

- 8æ ¸cpuä½¿ç”¨644%ï¼Œå†…å­˜ä½¿ç”¨2.7%ï¼ŒQPS ä¸º **16669.53** 
- å¹³å‡å»¶è¿Ÿä¸º 217.09ms



### 4.3 æµ‹è¯•ç»“æœ

**500å¹¶å‘(å®¢æˆ·ç«¯æ€§èƒ½æŒ‡æ ‡)**

| åœºæ™¯              | CPUï¼ˆ8æ ¸ï¼‰ | å†…å­˜ï¼ˆ32Gï¼‰ | QPS      | å¹³å‡å»¶è¿Ÿ    |
| --------------- | ------- | ------- | -------- | ------- |
| é“¾è·¯ç›‘æ§ï¼ˆæ— ï¼‰         | 668.90% | 2.50%   | 28482.96 | 17.27ms |
| é“¾è·¯ç›‘æ§ï¼ˆæœ‰ï¼‰         |         |         | 23867.47 | 20.48ms |
| é“¾è·¯ç›‘æ§ï¼ˆserver åœæ­¢ï¼‰ | 658.80% | 2.00%   | 26894.59 | 18.29ms |


**1000å¹¶å‘(å®¢æˆ·ç«¯æ€§èƒ½æŒ‡æ ‡)**

| åœºæ™¯              | CPUï¼ˆ8æ ¸ï¼‰ | å†…å­˜ï¼ˆ32Gï¼‰ | QPS      | å¹³å‡å»¶è¿Ÿ    |
| --------------- | ------- | ------- | -------- | ------- |
| é“¾è·¯ç›‘æ§ï¼ˆæ— ï¼‰         | 662.10% | 2.50%   | 26296.37 | 38.14ms |
| é“¾è·¯ç›‘æ§ï¼ˆæœ‰ï¼‰         |         |         | 22053.67 | 45.82ms |
| é“¾è·¯ç›‘æ§ï¼ˆserver åœæ­¢ï¼‰ | 655.50% | 2.70%   | 24091.45 | 41.85ms |

**5000å¹¶å‘(å®¢æˆ·ç«¯æ€§èƒ½æŒ‡æ ‡)**

| åœºæ™¯              | CPUï¼ˆ8æ ¸ï¼‰ | å†…å­˜ï¼ˆ32Gï¼‰ | QPS      | å¹³å‡å»¶è¿Ÿ     |
| --------------- | ------- | ------- | -------- | -------- |
| é“¾è·¯ç›‘æ§ï¼ˆæ— ï¼‰         | 646.10% | 2.50%   | 17829.78 | 213.71ms |
| é“¾è·¯ç›‘æ§ï¼ˆæœ‰ï¼‰         |         |         | 15207.78 | 248.63ms |
| é“¾è·¯ç›‘æ§ï¼ˆserver åœæ­¢ï¼‰ | 644%    | 2.70%   | 16669.53 | 217.09ms |

* 1ã€é“¾è·¯å‹æµ‹å¯¹QPSå’Œå¹³å‡å»¶æ—¶æœ‰å½±å“ã€‚
* 2ã€skywalking æŒ‚æ‰åå¯¹å¾®æœåŠ¡æ­£å¸¸ä½¿ç”¨ä¸”æ€§èƒ½è¾ƒæœ‰é“¾è·¯ç›‘æ§æœ‰æ‰€æå‡
* 3ã€skywalkingå®¢æˆ·ç«¯å¯¹cpuåŠå†…å­˜å½±å“ä¸æ˜¯å¾ˆæ˜æ˜¾




**ESä¸­é“¾è·¯æ—¥å¿—å¢é•¿æƒ…å†µ**


| åœºæ™¯         | ç£ç›˜ä½¿ç”¨æƒ…å†µ | æ—¥å¿—æ•°     | ä½¿ç”¨æƒ…å†µ | åœºæ™¯         |
| ---------- | ------ | ------- | ---- | ---------- |
| ç£ç›˜ä½¿ç”¨ï¼ˆæœªæµ‹è¯•å‰ï¼‰ | 138G   | 0       | 0    | ç£ç›˜ä½¿ç”¨ï¼ˆæœªæµ‹è¯•å‰ï¼‰ |
| ç£ç›˜ä½¿ç”¨ï¼ˆæµ‹è¯•ä¸­ï¼‰  | 153G   | 1141511 | 15G  | ç£ç›˜ä½¿ç”¨ï¼ˆæµ‹è¯•ä¸­ï¼‰  |
| ç£ç›˜ä½¿ç”¨ï¼ˆæµ‹è¯•ä¸­ï¼‰  | 197G   | 3799685 | 59G  | ç£ç›˜ä½¿ç”¨ï¼ˆæµ‹è¯•ä¸­ï¼‰  |



**å…¶ä»–æµ‹è¯•åŠç»“è®º**

> skywalkingåœæ‰åé‡æ–°å¯åŠ¨åæ˜¯å¦æ¢å¤æ—¥å¿—æ”¶é›†åŠŸèƒ½ï¼Ÿ

* yes




## 5 ä½¿ç”¨è¯´æ˜



### 5.1 é…ç½®è¦†ç›–



Skywalkingæ”¯æŒçš„å‡ ç§é…ç½®æ–¹å¼å…¶ä¸­ä¼˜å…ˆçº§å¦‚ä¸‹ï¼š

æ¢é’ˆé…ç½® > ç³»ç»Ÿé…ç½® >ç³»ç»Ÿç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ä¸­çš„å€¼

**5.1.1 ç³»ç»Ÿé…ç½®ï¼ˆSystem properties)**

é€šè¿‡ä½¿ç”¨-Dskywalking. å¦‚ä¸‹è¿›è¡Œ agent.service_name çš„è¦†ç›–
```
-Dskywalking.agent.service_name=skywalking_mysql
```



**5.1.2 æ¢é’ˆé…ç½®ï¼ˆAgent optionsï¼‰**


```
-javaagent:/path/to/skywalking-agent.jar=[option1]=[value1],[option2]=[value2]
```

**æ¡ˆä¾‹**
é€šè¿‡ å¦‚ä¸‹è¿›è¡Œ agent.service_name çš„è¦†ç›–

```
-javaagent:/path/to/skywalking-agent.jar=agent.service_name=skywalking_mysql
```

**ç‰¹æ®Šå­—ç¬¦**
å¦‚æœé…ç½®ä¸­åŒ…å«åˆ†éš”ç¬¦( , æˆ–è€… =) , å°±å¿…é¡»ä½¿ç”¨å¼•å·åŒ…è£¹èµ·æ¥

```
-javaagent:/path/to/skywalking-agent.jar=agent.ignore_suffix='.jpg,.jpeg'
```



**5.1.3 ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ˆSystem environment variablesï¼‰**

é…ç½®åœ¨æ“ä½œç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ä¸­
ç”±äºagent.service_nameé…ç½®é¡¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```
# The service name in UI 
agent.service_name=${SW_AGENT_NAME:Your_ApplicationName}
12
```

å¯ä»¥åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®SW_AGENT_NAMEçš„å€¼æ¥æŒ‡å®šæœåŠ¡åã€‚



**è¦†ç›–ä¼˜å…ˆçº§**
æ¢é’ˆé…ç½® > ç³»ç»Ÿé…ç½® >ç³»ç»Ÿç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ä¸­çš„å€¼

æ‰€ä»¥æˆ‘ä»¬çš„å¯åŠ¨å‘½ä»¤å¯ä»¥ä¿®æ”¹ä¸º

```
java -javaagent:/usr/local/skywalking/apache-skywalking-apm- 
bin/agent_mysql/skywalking-agent.jar - 
Dskywalking.agent.service_name=skywalking_mysql -jar skywalking_mysql.jar &
```

æˆ–è€…

```
java -javaagent:/usr/local/skywalking/apache-skywalking-apm- 
bin/agent_mysql/skywalking-agent.jar=agent.service_name=skywalking_mysql -jar skywalking_mysql.jar &
```



### 5.2 ä»£ç ä¸­æ·»åŠ é¢å¤–é“¾è·¯ä¿¡æ¯

Skywalkingæä¾›æˆ‘ä»¬Traceå·¥å…·åŒ…ï¼Œç”¨äºåœ¨è¿½è¸ªé“¾è·¯æ—¶è¿›è¡Œä¿¡æ¯çš„æ‰“å°

**pomæ–‡ä»¶**

```
    <properties>
        <java.version>1.8</java.version>
        <skywalking.version>8.1.0</skywalking.version>
    </properties>

        <!--skywalking traceå·¥å…·åŒ…-->
        <dependency>
            <groupId>org.apache.skywalking</groupId>
            <artifactId>apm-toolkit-trace</artifactId>
            <version>${skywalking.version}</version>
        </dependency>
```


> æ·»åŠ äº†skywalking traceçš„å·¥å…·åŒ…, è¯¥å·¥å…·åŒ…ç‰ˆæœ¬éœ€è¦ä¸skywalkingç‰ˆæœ¬ç›¸åŒ, è¿™é‡Œé‡‡ç”¨8.1.0



**PluginController**

```
import org.apache.skywalking.apm.toolkit.trace.ActiveSpan;
import org.apache.skywalking.apm.toolkit.trace.TraceContext;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class PluginController {

    //è·å–trace idï¼Œå¯ä»¥åœ¨RocketBotè¿½è¸ªä¸­è¿›è¡ŒæŸ¥è¯¢
    @GetMapping("/getTraceId")
    public String getTraceId(){
        //ä½¿å½“å‰é“¾è·¯æŠ¥é”™ï¼Œå¹¶ä¸”æç¤ºæŠ¥é”™ä¿¡æ¯
        ActiveSpan.error(new RuntimeException("Test-Error-Throwable"));
        //æ‰“å°infoä¿¡æ¯
        ActiveSpan.info("Test-Info-Msg");
        //æ‰“å°debugä¿¡æ¯
        ActiveSpan.debug("Test-debug-Msg");
        return TraceContext.traceId();
    }
}

```

ä½¿ç”¨TraceContext.traceId()å¯ä»¥æ‰“å°å‡ºå½“å‰è¿½è¸ªçš„IDï¼Œæ–¹ä¾¿åœ¨RocketBotä¸­è¿›è¡Œæœç´¢ã€‚

**ActiveSpanæä¾›äº†ä¸‰ä¸ªæ–¹æ³•è¿›è¡Œä¿¡æ¯çš„æ‰“å°**

- erroræ–¹æ³•ä¼šå°†æœ¬æ¬¡è°ƒç”¨å˜ä¸ºå¤±è´¥çŠ¶æ€ï¼ŒåŒæ—¶å¯ä»¥æ‰“å°å¯¹åº”çš„å †æ ˆä¿¡æ¯å’Œé”™è¯¯æç¤ºã€‚
- infoæ–¹æ³•æ‰“å°infoçº§åˆ«çš„ä¿¡æ¯ã€‚
- debugæ–¹æ³•æ‰“å°debugçº§åˆ«çš„ä¿¡æ¯ã€‚




### 5.3 è¿‡æ»¤æŒ‡å®šçš„ç«¯ç‚¹

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€äº›ç«¯ç‚¹ï¼ˆæ¥å£ï¼‰å¹¶ä¸éœ€è¦å»è¿›è¡Œç›‘æ§ï¼Œ


**éƒ¨ç½²æ–¹å¼**

å°†agentä¸­çš„ /agent/optional-plugins/apm-trace-ignore-plugin-6.4.0.jaræ’ä»¶æ‹·è´åˆ° pluginsç›®å½•ä¸­ã€‚

```
cd /usr/local/skywalking/agent
cp optional-plugins/apm-trace-ignore-plugin-8.1.0.jar plugins/apm-trace-ignore-plugin-8.1.0.jar
```

å¯åŠ¨åº”ç”¨

```
/usr/local/java/jdk1.8/bin/java -javaagent:/usr/local/skywalking/agent/skywalking-agent.jar -Dskywalking.agent.service_name=loit-gateway -Dskywalking.collector.backend_service=172.16.203.76:11800 - 
Dskywalking.trace.ignore_path=/exclude -Xms512m -Xmx512m -XX:PermSize=128M -XX:MaxPermSize=256M -jar -Dlogging.config=/home/soft/loit-gateway-7001/logback-dev.xml  -Dlogging.path=/home/soft/loit-gateway-7001/logs $KILL_PROCESS_NAME  --spring.config.location=file:./application-test7001.yml &

```

> è¿™é‡Œæ·»åŠ -Dskywalking.trace.ignore_path=/excludeå‚æ•°æ¥æ ‡è¯†éœ€è¦è¿‡æ»¤å“ªäº›è¯·æ±‚ï¼Œæ”¯æŒ Ant Pathè¡¨è¾¾å¼ï¼š

- /path/*, /path/**, /path/?
  - ? åŒ¹é…ä»»ä½•å•å­—ç¬¦
  - \* åŒ¹é…0æˆ–è€…ä»»æ„æ•°é‡çš„å­—ç¬¦
  - ** åŒ¹é…0æˆ–è€…æ›´å¤šçš„ç›®å½•



### 5.4 å‘Šè­¦åŠŸèƒ½



**5.4.1 å‘Šè­¦åŠŸèƒ½ç®€ä»‹**

Skywalkingæ¯éš”ä¸€æ®µæ—¶é—´æ ¹æ®æ”¶é›†åˆ°çš„é“¾è·¯è¿½è¸ªçš„æ•°æ®å’Œé…ç½®çš„å‘Šè­¦è§„åˆ™ï¼ˆå¦‚æœåŠ¡å“åº”æ—¶é—´ã€æœåŠ¡å“åº” æ—¶é—´ç™¾åˆ†æ¯”ï¼‰ç­‰ï¼Œåˆ¤æ–­å¦‚æœè¾¾åˆ°é˜ˆå€¼åˆ™å‘é€ç›¸åº”çš„å‘Šè­¦ä¿¡æ¯ã€‚å‘é€å‘Šè­¦ä¿¡æ¯æ˜¯é€šè¿‡è°ƒç”¨webhookæ¥å£å®Œ æˆï¼Œå…·ä½“çš„webhookæ¥å£å¯ä»¥ä½¿ç”¨è€…è‡ªè¡Œå®šä¹‰ï¼Œä»è€Œå¼€å‘è€…å¯ä»¥åœ¨æŒ‡å®šçš„webhookæ¥å£ä¸­ç¼–å†™å„ç§å‘Š è­¦æ–¹å¼ï¼Œæ¯”å¦‚é‚®ä»¶ã€çŸ­ä¿¡ç­‰ã€‚å‘Šè­¦çš„ä¿¡æ¯ä¹Ÿå¯ä»¥åœ¨RocketBotä¸­æŸ¥çœ‹åˆ°ã€‚

ä»¥ä¸‹æ˜¯é»˜è®¤çš„å‘Šè­¦è§„åˆ™é…ç½®ï¼Œä½äºskywalkingå®‰è£…ç›®å½•ä¸‹çš„conï¬gæ–‡ä»¶å¤¹ä¸‹ alarm-settings.ymlæ–‡ä»¶ ä¸­ï¼š

```
rules:
  # Rule unique name, must be ended with `_rule`.
  service_resp_time_rule:
    metrics-name: service_resp_time
    op: ">"
    threshold: 1000
    period: 10
    count: 3
    silence-period: 5
    message: Response time of service {name} is more than 1000ms in 3 minutes of last 10 minutes.
  
webhooks:
#  - http://127.0.0.1/notify/
#  - http://127.0.0.1/go-wechat/
```

**ä»¥ä¸Šæ–‡ä»¶å®šä¹‰äº†é»˜è®¤çš„4ç§è§„åˆ™**

1. æœ€è¿‘3åˆ†é’Ÿå†…æœåŠ¡çš„å¹³å‡å“åº”æ—¶é—´è¶…è¿‡1ç§’
2. æœ€è¿‘2åˆ†é’ŸæœåŠ¡æˆåŠŸç‡ä½äº80%
3. æœ€è¿‘3åˆ†é’Ÿ90%æœåŠ¡å“åº”æ—¶é—´è¶…è¿‡1ç§’
4. æœ€è¿‘2åˆ†é’Ÿå†…æœåŠ¡å®ä¾‹çš„å¹³å‡å“åº”æ—¶é—´è¶…è¿‡1ç§’ è§„åˆ™ä¸­çš„å‚æ•°å±æ€§å¦‚ä¸‹

**å±æ€§å‚ç…§è¡¨**

| å±æ€§             | å«ä¹‰                          |
| -------------- | --------------------------- |
| metrics-name   | oalè„šæœ¬ä¸­çš„åº¦é‡åç§°                 |
| threshold      | é˜ˆå€¼ï¼Œä¸metrics-nameå’Œä¸‹é¢çš„æ¯”è¾ƒç¬¦å·ç›¸åŒ¹é… |
| op             | æ¯”è¾ƒæ“ä½œç¬¦ï¼Œå¯ä»¥è®¾å®š>,<,=             |
| period         | å¤šä¹…æ£€æŸ¥ä¸€æ¬¡å½“å‰çš„æŒ‡æ ‡æ•°æ®æ˜¯å¦ç¬¦åˆå‘Šè­¦è§„åˆ™ï¼Œå•ä½åˆ†é’Ÿ  |
| count          | è¾¾åˆ°å¤šå°‘æ¬¡åï¼Œå‘é€å‘Šè­¦æ¶ˆæ¯               |
| silence-period | åœ¨å¤šä¹…ä¹‹å†…ï¼Œå¿½ç•¥ç›¸åŒçš„å‘Šè­¦æ¶ˆæ¯             |
| message        | å‘Šè­¦æ¶ˆæ¯å†…å®¹                      |
| include-names  | æœ¬è§„åˆ™å‘Šè­¦ç”Ÿæ•ˆçš„æœåŠ¡åˆ—è¡¨                |

> webhookså¯ä»¥é…ç½®å‘Šè­¦äº§ç”Ÿæ—¶çš„è°ƒç”¨åœ°å€ã€‚



**5.4.2 å‘Šè­¦åŠŸèƒ½è¯´æ˜**


**WebHooks**

> äº§ç”Ÿå‘Šè­¦æ—¶ä¼šè°ƒç”¨webhookæ¥å£ï¼Œè¯¥æ¥å£å¿…é¡»æ˜¯Postç±»å‹ï¼ŒåŒæ—¶æ¥å£å‚æ•°ä½¿ç”¨RequestBodyã€‚å‚ æ•°æ ¼å¼ä¸ºï¼š

```
[{
	"scopeId": 1,
	"scope": "SERVICE",
	"name": "serviceA",
	"id0": 12,
	"id1": 0,
	"ruleName": "service_resp_time_rule",
	"alarmMessage": "alarmMessage xxxx",
	"startTime": 1560524171000
}, {
	"scopeId": 1,
	"scope": "SERVICE",
	"name": "serviceB",
	"id0": 23,
	"id1": 0,
	"ruleName": "service_resp_time_rule",
	"alarmMessage": "alarmMessage yyy",
	"startTime": 1560524171000
}]
```

**AlarmMessage**

```
public class AlarmMessage {
    private int scopeId;
    private String name;
    private int id0;
    private int id1;
    //å‘Šè­¦çš„æ¶ˆæ¯
    private String alarmMessage;
    //å‘Šè­¦çš„äº§ç”Ÿæ—¶é—´
    private long startTime;
}
```

åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨å¯ä»¥åœ¨webhookæ¥å£ä¸­å¯¹æ¥çŸ­ ä¿¡ã€é‚®ä»¶ç­‰å¹³å°ï¼Œå½“å‘Šè­¦å‡ºç°æ—¶èƒ½è¿…é€Ÿå‘é€ä¿¡æ¯ç»™å¯¹åº”çš„å¤„ç†äººå‘˜ï¼Œæé«˜æ•…éšœå¤„ç†çš„é€Ÿåº¦ã€‚



## 6ã€é›†ç¾¤åŠå…¶æ€§èƒ½

### é›†ç¾¤é…ç½®

1.è¯„ä¼°åœ¨ä¸šåŠ¡æœåŠ¡çš„æè‡´qpsä¸‹ï¼Œskywalkingæ˜¯å¦å¯¹ä¸šåŠ¡æœ‰å½±å“ã€‚è¿™ä¸ªæ˜¯æœ€é‡è¦çš„ã€‚
* å³ä½¿æ˜¯bizæœºå™¨çš„cpuï¼…usé«˜è¾¾100ï¼…ï¼Œå®ƒå¯¹bizçš„è¯·æ±‚ä¹Ÿæ²¡æœ‰å½±å“

2.å‹æµ‹skywalking-collectorå•èŠ‚ç‚¹QPSæé™ã€‚
*æ¯ä¸ªæ”¶é›†å™¨ æ”¯æŒ10K+qps
* ä½¿ç”¨3å°skywalking-collector

çº¿ä¸Šskywalking-collectorçš„jvmå‚æ•°ä½¿ç”¨ï¼š
```
   -server -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=256m -Xms6000M -Xmx6000M -XX:+UseG1GC -XX:LargePageSizeInBytes=128m
```


### é›†ç¾¤é…ç½®

**application.yml**

ä¿®æ”¹é›†ç¾¤æ³¨å†Œä¸­å¿ƒé…ç½®

```
cluster:
  selector: ${SW_CLUSTER:nacos}
  nacos:
    serviceName: ${SW_SERVICE_NAME:"SkyWalking_OAP_Cluster"}
    hostPort: ${SW_CLUSTER_NACOS_HOST_PORT:172.16.203.79:8010}
    # Nacos Configuration namespace
    namespace: ${SW_CLUSTER_NACOS_NAMESPACE:"public"}
```

å…¶ä¸­ gRPCHostæ”¹æˆå¯¹åº”æœåŠ¡å™¨çš„IP

```
core:
  selector: ${SW_CORE:default}
  default:
    gRPCHost: ${SW_CORE_GRPC_HOST:172.16.203.77}

```



ä¿®æ”¹å­˜å‚¨es

```
storage:
  selector: ${SW_STORAGE:elasticsearch}
  elasticsearch:
    nameSpace: ${SW_NAMESPACE:""}
    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:172.16.203.77:9200,172.16.203.78:9200,172.16.203.79:9200}
```



**dashboard é…ç½®ä¿®æ”¹**

/webapp/webapp.yml  ä¿®æ”¹ listOfServerrs

```
server:
  port: 8080

collector:
  path: /graphql
  ribbon:
    ReadTimeout: 10000
    # Point to all backend's restHost:restPort, split by ,
    listOfServers: 172.16.203.76:12800,172.16.203.77:12800,172.16.203.78:12800

```



**agent ç«¯é…ç½®**

```
collector.direct_servers=www.skywalking.service.io/collector.direct_servers=10.20.30.123:11800,10.20.30.124:11800,10.20.30.125:11800
```

```
172.16.203.76:11800,172.16.203.77:11800,172.16.203.78:11800
```



### 7ã€UIç•Œé¢ä»‹ç»

CPM:æ¯åˆ†é’Ÿè¯·æ±‚è°ƒç”¨æ¬¡æ•°ï¼ˆå¹³å‡ååé‡ï¼‰ã€‚

SLA: æœåŠ¡ç­‰çº§åè®®ï¼ˆç®€ç§°ï¼šSLAï¼Œå…¨ç§°ï¼šservice level agreementï¼‰ã€‚æ˜¯åœ¨ä¸€å®šå¼€é”€ä¸‹ä¸ºä¿éšœæœåŠ¡çš„æ€§èƒ½å’Œå¯ç”¨æ€§ï¼ŒæœåŠ¡æä¾›å•†ä¸ç”¨æˆ·é—´å®šä¹‰çš„ä¸€ç§åŒæ–¹è®¤å¯çš„åå®šã€‚é€šå¸¸è¿™ä¸ªå¼€é”€æ˜¯é©±åŠ¨æä¾›æœåŠ¡è´¨é‡çš„ä¸»è¦å› ç´ ã€‚å³æœåŠ¡å¯ç”¨æ€§ï¼Œå¦‚99.9,99.99,99.999

CLRï¼šï¼ˆå…¬å…±è¯­è¨€è¿è¡Œåº“,Common Language Runtimeï¼‰å’Œ Java è™šæ‹Ÿæœºä¸€æ ·ä¹Ÿæ˜¯ä¸€ä¸ªè¿è¡Œæ—¶ç¯å¢ƒï¼Œæ˜¯ä¸€ä¸ªå¯ç”±å¤šç§ç¼–ç¨‹è¯­è¨€ä½¿ç”¨çš„è¿è¡Œç¯å¢ƒã€‚CLR çš„æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼šå†…å­˜ç®¡ç†ã€ç¨‹åºé›†åŠ è½½ã€å®‰å…¨æ€§ã€å¼‚å¸¸å¤„ç†å’Œçº¿ç¨‹åŒæ­¥ï¼Œå¯ç”±é¢å‘ CLR çš„æ‰€æœ‰è¯­è¨€ä½¿ç”¨ã€‚å¹¶ä¿è¯åº”ç”¨å’Œåº•å±‚æ“ä½œç³»ç»Ÿä¹‹é—´å¿…è¦çš„åˆ†ç¦»ã€‚

ç™¾åˆ†ä½æ•°ï¼šskywalkingä¸­æœ‰P50ï¼ŒP75ï¼ŒP90ï¼ŒP95ï¼ŒP99è¿™ç§ç»Ÿè®¡å£å¾„ï¼Œå°±æ˜¯ç™¾åˆ†ä½æ•°çš„æ¦‚å¿µã€‚

> å¦‚ æœ‰50%çš„è¯·æ±‚å“åº”æ—¶é—´ä½äº1020msï¼Œæœ‰75%çš„è¯·æ±‚å“åº”æ—¶é—´ä½äº1200msï¼Œæœ‰90%çš„è¯·æ±‚å“åº”æ—¶é—´ä½äº2150msï¼Œæœ‰95%çš„è¯·æ±‚å“åº”æ—¶é—´ä½äº3140msï¼Œæœ‰99%çš„è¯·æ±‚å“åº”æ—¶é—´ä½äº3220msã€‚



### 8ã€é”™è¯¯æ’æŸ¥

skywalking-oap-server.log

é”™è¯¯ä¿¡æ¯**Elasticsearch exception [type=cluster_block_exception, reason=blocked by: [FORBIDDEN/12/index read-only / allow delete (api)**  è¡¨ç¤ºElasticSearchè¿›å…¥â€œåªè¯»â€æ¨¡å¼ï¼ŒèŠ‚ç‚¹æ— æ³•æ›´æ”¹ã€‚å¯èƒ½åŸå› æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³å¯¼è‡´ã€‚è§£å†³æ–¹å¼1ã€ä¿è¯å­˜å‚¨ç©ºé—´å……è¶³ 2ã€è®¾ç½®å¯¹åº”çš„ç´¢å¼•è§£é™¤â€œåªè¯»æ¨¡å¼â€ã€‚ skywalkingæ¯å¤©éƒ½ä¼šå‚æ•°æ–°ç´¢å¼•ï¼Œæ–°ç´¢å¼•æ˜¯æ˜¯è§£é™¤åªè¯»æ¨¡å¼çš„ã€‚

